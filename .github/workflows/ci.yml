name: CI Pipeline

on:
  push:
    branches: [ "main", "docs-archi-yoda", "ci_cd", "development" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-containers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          MYSQL_ROOT_PASSWORD=root
          MYSQL_DATABASE=yoda
          DATABASE_HOST=database
          DATABASE_PORT=3306
          DATABASE_NAME=yoda
          DATABASE_USER=root
          DATABASE_PASSWORD=root
          MINIO_ROOT_USER=minioadmin
          MINIO_ROOT_PASSWORD=minioadmin
          MINIO_ENDPOINT=minio:9000
          MINIO_ACCESS_KEY=minioadmin
          MINIO_SECRET_KEY=minioadmin
          EOF

      - name: Build Docker images
        run: docker compose build

      - name: Start containers
        run: docker compose up -d

      - name: Wait for database to be ready
        run: |
          echo "Waiting for database to initialize..."
          for i in {1..60}; do
            if docker exec yoda-database mysql -uroot -proot -e "SELECT 1" &> /dev/null; then
              echo "Database is ready!"
              break
            fi
            echo "Waiting for database... ($i/60)"
            sleep 2
          done

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:5000/api/health &> /dev/null; then
              echo "Backend is ready!"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done

      - name: Wait for frontend to be ready
        run: |
          echo "Waiting for frontend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:5173/ &> /dev/null; then
              echo "Frontend is ready!"
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep 2
          done

      - name: Check container status
        run: |
          echo "=== Container Status ==="
          docker ps -a
          echo ""
          echo "=== Database Logs ==="
          docker logs yoda-database --tail 50
          echo ""
          echo "=== MinIO Logs ==="
          docker logs yoda-minio --tail 50
          echo ""
          echo "=== Backend Logs ==="
          docker logs yoda-backend --tail 50
          echo ""
          echo "=== Frontend Logs ==="
          docker logs yoda-frontend --tail 50

      - name: Test backend health endpoint
        run: |
          echo "Testing backend health endpoint..."
          response=$(curl -s -w "\n%{http_code}" http://localhost:5000/api/health)
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "Status code: $status_code"
          echo "Response: $body"
          if [ "$status_code" != "200" ]; then
            echo "Health check failed with status code $status_code"
            exit 1
          fi
          if ! echo "$body" | grep -q "ok"; then
            echo "Health check response doesn't contain 'ok'"
            exit 1
          fi
          if ! echo "$body" | grep -q "ok"; then
            echo "Health check response doesn't contain 'ok'"
            exit 1
          fi

      - name: Test database connection
        run: |
          echo "Testing database connection..."
          response=$(curl -s -w "\n%{http_code}" http://localhost:5000/api/db-test)
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "Status code: $status_code"
          echo "Response: $body"
          if [ "$status_code" != "200" ]; then
            echo "Database test failed with status code $status_code"
            exit 1
          fi
          if ! echo "$body" | grep -q "success"; then
            echo "Database test response doesn't contain 'success'"
            exit 1
          fi

      - name: Test MinIO file listing
        run: |
          echo "Testing MinIO file listing..."
          response=$(curl -s -w "\n%{http_code}" http://localhost:5000/api/files)
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "Status code: $status_code"
          echo "Response: $body"
          # Skip if endpoint not found or requires authentication
          if [ "$status_code" = "404" ] || [ "$status_code" = "401" ]; then
            echo "Files endpoint not implemented or requires authentication, skipping..."
            exit 0
          fi
          if [ "$status_code" != "200" ]; then
            echo "MinIO test failed with status code $status_code"
            exit 1
          fi
        continue-on-error: true

      - name: Test frontend
        run: |
          echo "Testing frontend..."
          status_code=$(curl -s -w "%{http_code}" -o /dev/null http://localhost:5173/)
          echo "Frontend status code: $status_code"
          if [ "$status_code" != "200" ]; then
            echo "Frontend test failed with status code $status_code"
            exit 1
          fi

      - name: Test registration endpoint
        run: |
          echo "Testing user registration..."
          response=$(curl -s -X POST http://localhost:5000/api/register \
            -H "Content-Type: application/json" \
            -d '{"email":"testci@example.com","password":"ValidPass1234!@#$","name":"TestCI","prenom":"User","second_password":"ValidPass1234!@#$"}')
          echo "Response: $response"
          if echo "$response" | grep -q "error"; then
            echo "Registration test passed (validation working)"
          else
            echo "Registration might have succeeded or failed correctly"
          fi

      - name: Test password validation
        run: |
          echo "Testing password validation with weak password..."
          response=$(curl -s -X POST http://localhost:5000/api/register \
            -H "Content-Type: application/json" \
            -d '{"email":"weak@example.com","password":"weak","name":"Test","prenom":"User","second_password":"weak"}')
          echo "Response: $response"
          if echo "$response" | grep -q "16 caract√®res"; then
            echo "Password validation working correctly"
          else
            echo "Warning: Password validation might not be working"
            exit 1
          fi

      - name: Lint Python code
        run: |
          echo "Linting Python code..."
          docker exec yoda-backend pip install ruff --quiet || true
          docker exec yoda-backend ruff check backend/ --select E,F,W --ignore E501 || echo "Linting warnings found but continuing..."
        continue-on-error: true

      - name: Lint TypeScript code
        run: |
          echo "Linting TypeScript/Vue code..."
          docker exec yoda-frontend npm run lint || echo "Linting warnings found but continuing..."
        continue-on-error: true

      - name: Test login endpoint
        run: |
          echo "Testing login with valid credentials..."
          # First register a user
          curl -s -X POST http://localhost:5000/api/register \
            -H "Content-Type: application/json" \
            -d '{"email":"login@example.com","password":"LoginTest1234!@#$","name":"Login","prenom":"Test","second_password":"LoginTest1234!@#$"}' || true
          
          # Then try to login
          response=$(curl -s -X POST http://localhost:5000/api/login \
            -H "Content-Type: application/json" \
            -d '{"email":"login@example.com","password":"LoginTest1234!@#$"}')
          echo "Login response: $response"
          if echo "$response" | grep -q "token\|error"; then
            echo "Login endpoint responding correctly"
          else
            echo "Warning: Login endpoint might have issues"
          fi

      - name: Test document upload
        run: |
          echo "Testing document upload..."
          # Register and login first
          curl -s -X POST http://localhost:5000/api/register \
            -H "Content-Type: application/json" \
            -d '{"email":"doc@example.com","password":"DocTest1234!@#$","name":"Doc","prenom":"Test","second_password":"DocTest1234!@#$"}' || true
          
          login_response=$(curl -s -X POST http://localhost:5000/api/login \
            -H "Content-Type: application/json" \
            -d '{"email":"doc@example.com","password":"DocTest1234!@#$"}')
          
          token=$(echo "$login_response" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
          echo "Token obtained: ${token:0:20}..."
          
          if [ -z "$token" ]; then
            echo "Failed to obtain token"
            exit 1
          fi
          
          # Test upload with minimal data
          upload_response=$(curl -s -X POST http://localhost:5000/api/documents/upload \
            -H "Authorization: Bearer $token" \
            -H "Content-Type: application/json" \
            -d '{
              "file_name": "test.txt",
              "file_data": "dGVzdCBkYXRh",
              "dek_encrypted": "encrypted_dek",
              "iv": "abc123",
              "sha256": "hash123"
            }')
          echo "Upload response: $upload_response"
          if echo "$upload_response" | grep -q "success\|error"; then
            echo "Document upload endpoint responding correctly"
          fi

      - name: Test document listing
        run: |
          echo "Testing document listing..."
          login_response=$(curl -s -X POST http://localhost:5000/api/login \
            -H "Content-Type: application/json" \
            -d '{"email":"doc@example.com","password":"DocTest1234!@#$"}')
          
          token=$(echo "$login_response" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
          
          if [ -z "$token" ]; then
            echo "Failed to obtain token for list test"
            exit 1
          fi
          
          # Test document listing
          list_response=$(curl -s -X GET http://localhost:5000/api/documents/list \
            -H "Authorization: Bearer $token")
          echo "List response: $list_response"
          if echo "$list_response" | grep -q "documents\|success"; then
            echo "Document listing endpoint working correctly"
          else
            echo "Warning: Document listing might have issues"
          fi

      - name: Test user info endpoint
        run: |
          echo "Testing user info endpoint..."
          login_response=$(curl -s -X POST http://localhost:5000/api/login \
            -H "Content-Type: application/json" \
            -d '{"email":"doc@example.com","password":"DocTest1234!@#$"}')
          
          token=$(echo "$login_response" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
          
          if [ -z "$token" ]; then
            echo "Failed to obtain token"
            exit 1
          fi
          
          # Get user name
          user_response=$(curl -s -X GET http://localhost:5000/api/name_user \
            -H "Authorization: Bearer $token")
          echo "User info response: $user_response"
          if echo "$user_response" | grep -q "prenom\|nom"; then
            echo "User info endpoint working correctly"
          fi

      - name: Test public key endpoint
        run: |
          echo "Testing public key endpoint..."
          login_response=$(curl -s -X POST http://localhost:5000/api/login \
            -H "Content-Type: application/json" \
            -d '{"email":"doc@example.com","password":"DocTest1234!@#$"}')
          
          token=$(echo "$login_response" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
          
          if [ -z "$token" ]; then
            echo "Failed to obtain token"
            exit 1
          fi
          
          # Get public key
          pubkey_response=$(curl -s -X POST http://localhost:5000/api/user/public-key \
            -H "Authorization: Bearer $token" \
            -H "Content-Type: application/json" \
            -d '{}')
          echo "Public key response: $pubkey_response"
          if echo "$pubkey_response" | grep -q "public_key\|error"; then
            echo "Public key endpoint responding correctly"
          fi

      - name: Test authentication without token
        run: |
          echo "Testing authentication protection..."
          response=$(curl -s -X GET http://localhost:5000/api/documents/list)
          status_code=$(curl -s -w "%{http_code}" -o /dev/null http://localhost:5000/api/documents/list)
          echo "Status code without token: $status_code"
          if [ "$status_code" = "401" ]; then
            echo "Authentication protection working correctly"
          else
            echo "Warning: Protected endpoint should return 401"
          fi

      - name: Test invalid token
        run: |
          echo "Testing invalid token rejection..."
          response=$(curl -s -X GET http://localhost:5000/api/documents/list \
            -H "Authorization: Bearer invalid_token_12345")
          echo "Response: $response"
          if echo "$response" | grep -q "Invalid token\|error"; then
            echo "Invalid token rejection working correctly"
          fi

      - name: Database integrity check
        run: |
          echo "Checking database integrity..."
          # Verify tables exist
          docker exec yoda-database mysql -uroot -proot -D yoda -e "
            SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='yoda' ORDER BY TABLE_NAME;
          "
          echo "Tables verified successfully"

      - name: Stop containers
        if: always()
        run: docker compose down -v